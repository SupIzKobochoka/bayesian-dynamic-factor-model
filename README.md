# Иерархическая байесовская факторная модель макроэкономических индикаторов

Этот репозиторий содержит ноутбук `VAR_model_actual.ipynb`, в котором реализована факторная модель с латентными переменными для 
анализа динамики потребления, ВВП и инвестиций в наборе стран. Ниже приведено описание данных, математической постановки и вычис
лительных шагов.

## Данные и подготовка
* Источник данных — Excel-файл с месячными темпами роста в процентах по трем индикаторам \(Y = (\text{CONS}, \text{GDP}, \text{INV})\) для 51 страны за период 2001–2023 гг.
* После загрузки таблица приводится к «длинному» формату \((\text{дата}, \text{страна}, \text{показатель})\), сортируется по вр
емени и дополняется пропусками.
* Значения делятся на 100, чтобы перейти от процентов к долям, и центрируются по каждой стране — так удаляется страновая констант
та и внимание концентрируется на совместных колебаниях.
* Страны группируются на развитые и развивающиеся; эта разбивка образует региональные блоки.

## Базовая модель для 51 страны
Для каждой страны \(n\), показателя \(i\) и момента времени \(t\) наблюдение описывается структурой
\[
 y_{i,t,n} = a_{i,n} + b^{\text{world}}_{i,n} f^{\text{world}}_t + b^{\text{region}}_{i,n} f^{\text{region}}_{r(n),t} + b^{\text{country}}_{i,n} f^{\text{country}}_{n,t} + e_{i,t,n}.
\]
Здесь \(f^{\text{world}}_t\) — глобальный фактор, \(f^{\text{region}}_{r(n),t}\) — фактор региона \(r(n)\), а \(f^{\text{country}}_{n,t}\) — специфический для страны фактор.

### Динамика латентных факторов
Каждый фактор следует авторегрессии порядка 3:
\[
 f^{\ell}_{t} = \phi^{\ell}_1 f^{\ell}_{t-1} + \phi^{\ell}_2 f^{\ell}_{t-2} + \phi^{\ell}_3 f^{\ell}_{t-3} + \eta^{\ell}_t, \qquad \ell \in \{\text{world}, \text{region}, \text{country}\}.
\]
Инновации \(\eta^{\ell}_t\) независимы и нормально распределены с дисперсией \(\sigma^{2,\ell}_\eta\).

### Остатки наблюдений
Ошибки измерения также описываются авторегрессией порядка 3:
\[
 e_{i,t,n} = \rho_{1,i,n} e_{i,t-1,n} + \rho_{2,i,n} e_{i,t-2,n} + \rho_{3,i,n} e_{i,t-3,n} + u_{i,t,n},
\]
где инновации \(u_{i,t,n} \sim \mathcal N(0, \sigma^2_{u,i,n})\).

### Априорные распределения
* Константы \(a_{i,n} \sim \mathcal N(0, 1)\).
* Нагрузки на факторы: для потребления используются полунормальные априоры (фиксируют знак фактора), для ВВП и инвестиций — \(\mathcal N(0,1)\).
* Коэффициенты AR(3) для факторов и остатков имеют априоры \(\mathcal N(0, (1, 1/2, 1/4))\) по лагам.
* Дисперсии инноваций \(\sigma^2_{\eta}\), \(\sigma^2_{u}\) и дисперсии наблюдений \(\sigma^2_{y}\) подчиняются \(\text{InverseGamma}(3, 0{,}0005)\).

## Альтернативная модель с переключением регионального фактора (25 стран)
Для поднабора из 25 стран Россия может плавно переключаться между региональными факторами развитых (dev) и развивающихся (em) э
кономик. Наблюдение для России записывается как
\[
 y^{\text{RUS}}_{i,t} = a_{i,\text{RUS}} + b^{\text{world}}_{i,\text{RUS}} f^{\text{world}}_t + w_t b^{\text{region}}_{i,\text{RUS}} f^{\text{region}}_{\text{dev},t} + (1-w_t) b^{\text{region}}_{i,\text{RUS}} f^{\text{region}}_{\text{em},t} + b^{\text{country}}_{i,\text{RUS}} f^{\text{country}}_{\text{RUS},t} + e_{i,t,\text{RUS}},
\]
где вес
\[
 w_t = \frac{1 + \tanh(\alpha_t)}{2}
\]
лежит в диапазоне \([0, 1]\). Латентный процесс \(\alpha_t\) следует AR(3) с теми же априорами на коэффициенты, а дисперсия \(\sigma^2_{\alpha}\) имеет \(\text{InverseGamma}(1, 0{,}2)\).

## Оценивание и вычисления
* Модель построена в PyMC 5/PyTensor; для ускорения используется движок NumPyro (`pmjax.sample_numpyro_nuts`).
* Запуск NUTS: 10 000 шагов разогрева и 5 000 выборок (для альтернативной модели — 5 000 и 3 000 соответственно).
* Результаты сохраняются в формате NetCDF и анализируются с помощью ArviZ (трассы, средние, доверительные интервалы).

## Анализ результатов
После оценки извлекаются траектории глобального, региональных и страновых факторов, а также оценки нагрузок. Построенные графики
 показывают средние и 95 % доверительные интервалы. Дополнительно рассматриваются сценарии с уменьшенным числом стран и проверяет
ся чувствительность переключения России между региональными факторами.

## Как воспроизвести
1. Откройте `VAR_model_actual.ipynb` в Jupyter Lab/Notebook.
2. Убедитесь, что установлены зависимости: `pymc`, `numpyro`, `pytensor`, `arviz`, `numpy`, `pandas`, `matplotlib`.
3. Последовательно выполните ячейки: подготовка данных, построение модели, запуск выборки и визуализация.

